!function(o){"use strict";var i="editpricehelper",a=0,n={priceType:"notax",otherPriceInput:null,taxRateInput:null,taxRate:null,taxRateInPercent:!1,precision:2,urlCalculate:null,displayTaxAmount:!0,mainLabel:"Price",priceTaxLabel:"All taxes included",priceNoTaxLabel:"Pre-tax",taxAmountLabel:"Tax",defaultLabel:"default",priceTaxClass:"price price_tax",priceNoTaxClass:"price price_notax",taxAmountClass:"price price_tax-amount",taxRateClass:"price price_tax-rate",taxRateDisplayClass:"price__tax-rate",labelClass:"price__label",inputClass:"price__input",debug:!1};function r(t,e){this.$element=o(t),this.options=o.extend({},n,e,this.$element.data()),this.identifier=i+"-"+a++,this.priceType=this.options.priceType,this.otherPriceType=this.getOtherPriceType(this.priceType),this.hasSinglePriceInput=0===o(this.options.otherPriceInput).length,this.hasTaxRateInput=0<o(this.options.taxRateInput).length,this.$inputs=null,this.$taxRateDisplay=null,this.init()}r.prototype.init=function(){var t=this.check();t?console.log("Edit Price Helper error: "+t):(this.setup(),this.addInteractions(),this.onInit&&"function"==typeof this.onInit&&this.onInit())},r.prototype.check=function(){var t="",e=this.$element.prop("tagName"),a=this.$element.attr("type");return"INPUT"!==e||"text"!==a&&"number"!==a?t="Main input type need to be `text` or `number`":this.hasTaxRateInput||this.options.taxRate||(t="No taxe rate provided, use `taxRateInput` or `taxRate`."),t},r.prototype.setup=function(){var i,n,r=this,t=this.options,e={},a=this.$element.attr("id"),s=o('label[for="'+a+'"]'),u=this.priceType,p=this.otherPriceType;i={main:t.mainLabel,notax:t.priceNoTaxLabel,tax:t.priceTaxLabel,taxAmount:t.taxAmountLabel,defaultTaxAmount:t.defaultTaxAmountLabel},n={notax:t.priceNoTaxClass,tax:t.priceTaxClass,taxAmount:t.taxAmountClass,taxRate:t.taxRateClass,taxRateDisplay:t.taxRateDisplayClass,input:t.inputClass,label:t.labelClass},(this.$inputs=e)[u]=this.$element.data("priceType",u),this.hasTaxRateInput&&(e.taxRate=o(t.taxRateInput)),this.hasSinglePriceInput?(e[p]=e[u].clone(!1,!1).attr("value","").removeData().removeAttr("name required").attr("id",a+"_helper").data("priceType",p).insertAfter(e[u]),t.displayTaxAmount&&(e.taxAmount=e[p].clone(!1,!1).removeData().removeAttr("min max step").attr("type","text").attr({disabled:"",readonly:""}).attr("id",a+"_tax_amount").insertAfter(e[p])),this.$taxRateDisplay=o("<span>").addClass(n.taxRateDisplay).html(this.displayTaxRate()),o.each(e,function(t){var e,a=o(this).attr("id");o(this).addClass(n.input).wrap(o("<span>").addClass(n[t])),i[t]&&(e=o("<label>").attr("for",a).addClass(n.label).html(i[t]),"taxAmount"===t&&e.append(r.$taxRateDisplay),o(this).before(e))}),i.main&&s.contents().filter(function(){return 3===this.nodeType}).first().replaceWith(i.main)):e[p]=o(t.otherPriceInput).data("priceType",p),o.each(e,function(){var t=Number.parseFloat(o(this).val());Number.isNumeric(t)&&o(this).data("value",t)}),this.syncInput(e[p])},r.prototype.addInteractions=function(){var n=this,t=this.$inputs,e="keyup."+this.identifier+" change."+this.identifier;o.each(t,function(i){"tax"===i||"notax"===i?o(this).bind(e,function(){var t=Number.parseFloat(o(this).val())||null,e=n.getOtherPriceType(i),a=n.$inputs[e];o(this).data("value",t),n.syncInput(a)}):"taxRate"===i&&o(this).bind(e,function(){var t=Number.parseFloat(o(this).val())||null;o(this).data("value",t),n.syncInput(n.$inputs.tax),n.$taxRateDisplay.html(n.displayTaxRate(t))})})},r.prototype.syncInput=function(e){var a,t=this,i=this.options,n=e.data("priceType"),r=this.getOtherPriceType(n),s=Number.parseFloat(this.$inputs[r].data("value"))||null,u=this.getTaxRate();Number.isNumeric(s)?i.urlCalculate?o.ajax({url:i.urlCalculate,dataType:"text",data:{price:s,priceType:r,taxRate:u},custom:t,cache:!1,error:function(t,e,a){console.log(a)}}).done(function(t){a=Number.parseFloat(t),this.custom.updatePriceInput(e,a)}):(a=this.calculatePrice(r,s),t.updatePriceInput(e,a)):t.updatePriceInput(e,null)},r.prototype.updatePriceInput=function(t,e){var a,i,n,r=this.options;a=Number.isNumeric(e)?e.toFixed(r.precision):e,t.data("value",e).val(a),this.highlight(t),r.displayTaxAmount&&(i=this.getTaxAmount(),n=Number.isNumeric(i)?i.toFixed(r.precision):i,this.$inputs.taxAmount.data("value",i).val(n),this.highlight(this.$inputs.taxAmount)),this.onUpdate&&"function"==typeof this.onUpdate&&this.onUpdate(t,e)},r.prototype.calculatePrice=function(t,e){var a=this.getTaxRate(),i=this.options.taxRateInPercent?100:1;if(Number.isNumeric(e)&&Number.isNumeric(a))switch(t){case"notax":e=Number.parseFloat(e*i*(i+a));break;case"tax":e=Number.parseFloat(e*i/(i+a))}return e},r.prototype.getOtherPriceType=function(t){return"notax"===t?"tax":"notax"},r.prototype.getPriceNoTax=function(){return Number.parseFloat(this.$inputs.notax.data("value"))},r.prototype.getPriceTax=function(){return Number.parseFloat(this.$inputs.tax.data("value"))},r.prototype.getTaxRate=function(){var t;return this.hasTaxRateInput?(t=Number.parseFloat(this.$inputs.taxRate.val())||0,!Number.isNumeric(t)&&this.options.taxRate&&(t=this.options.taxRate)):t=this.options.taxRate,t},r.prototype.getTaxAmount=function(){var t,e=this.getPriceNoTax(),a=this.getPriceTax();return Number.isNumeric(a)&&Number.isNumeric(e)&&(t=Math.max(a-e,0)),t},r.prototype.displayTaxRate=function(t){var e=this.options.taxRateInPercent,a=!Number.isNumeric(t)&&this.options.taxRate;return Number.isNumeric(t)||(t=this.getTaxRate()),!1===e&&(t*=100),t=t.toFixed(2),t+="&#37;",a&&(t+=" ("+this.options.defaultLabel+")"),t},r.prototype.highlight=function(t){t.addClass("highlight"),setTimeout(function(){t.removeClass("highlight")},500)},Number.parseFloat=Number.parseFloat||function(t){return parseFloat(t)},Number.isNumeric=Number.isNumeric||function(t){return isFinite(t)&&Number.parseFloat(t)==t},o.fn[i]=function(a){return this.each(function(){var t=o(this),e=t.data("plugin_"+i);e||t.data("plugin_"+i,e=new r(this,a))})}}(jQuery);